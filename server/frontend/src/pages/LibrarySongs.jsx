import React, { useState, useEffect } from 'react'
import { songsAPI } from '../services/api'
import { CustomTable } from '../components/Components'

export default function LibrarySongs({ onAdd, onEdit }) {
  const [search, setSearch] = useState('')
  const [showForm, setShowForm] = useState(false)
  const [songs, setSongs] = useState([])
  const [form, setForm] = useState({ title: '', artist: '', genre: '', album: '', release_date: '', duration: '' })
  const [editId, setEditId] = useState(null)
  const [loading, setLoading] = useState(true)

  // Fetch songs from API
  const fetchSongs = async () => {
    try {
      const data = await songsAPI.getAll()
      setSongs(data)
    } catch (error) {
      console.error('Error fetching songs:', error)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchSongs()
  }, [])

  const filteredSongs = songs.filter(
    (s) =>
      s.title.toLowerCase().includes(search.toLowerCase()) ||
      s.artist.toLowerCase().includes(search.toLowerCase()) ||
      s.album.toLowerCase().includes(search.toLowerCase())
  )

  // Format tanggal
  function formatDate(dateStr) {
    if (!dateStr) return '-'
    const date = new Date(dateStr)
    if (isNaN(date)) return dateStr
    return date
      .toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      })
      .replace(/ /g, ' ')
  }

  const columns = [
    { key: 'no', label: 'No' },
    { key: 'title', label: 'Song Title' },
    { key: 'artist', label: 'Artist' },
    { key: 'genre', label: 'Genre' },
    { key: 'album', label: 'Album' },
    { key: 'release_date', label: 'Release date' },
    { key: 'duration', label: 'Duration' },
    { key: 'actions', label: ' ' }
  ]

  const handleDelete = async (id) => {
    if (window.confirm('Are you sure you want to delete this song?')) {
      try {
        await fetch(`http://localhost:4000/songs/${id}`, { method: 'DELETE' })
        fetchSongs()
      } catch (error) {
        console.error('Error deleting song:', error)
      }
    }
  }

  const renderCell = (col, song, idx) => {
    if (col.key === 'no') return idx + 1
    if (col.key === 'title')
      return (
        <span className='text-lg font-semibold flex items-center gap-2'>
          <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 40 40' fill='none'>
            <path
              d='M18.2916 5.00332C18.3892 5.43429 18.3116 5.88636 18.0759 6.26015C17.8403 6.63394 17.4658 6.89886 17.0349 6.99665C14.2635 7.62857 11.7665 9.12968 9.90844 11.2809C8.05037 13.4322 6.92844 16.1209 6.70639 18.9548C6.48434 21.7887 7.17379 24.6194 8.67413 27.0338C10.1745 29.4482 12.4071 31.3199 15.0464 32.3757C17.6856 33.4316 20.5931 33.6164 23.3448 32.9031C26.0964 32.1898 28.548 30.6157 30.3419 28.4107C32.1358 26.2057 33.178 23.485 33.3165 20.6458C33.455 17.8066 32.6824 14.9975 31.1116 12.6283C30.9904 12.446 30.9064 12.2416 30.8642 12.0268C30.8221 11.812 30.8227 11.591 30.8659 11.3764C30.9533 10.9431 31.2092 10.5621 31.5774 10.3175C31.9456 10.0728 32.3959 9.98445 32.8293 10.0718C33.0439 10.1151 33.2479 10.2002 33.4295 10.3222C33.6112 10.4443 33.7671 10.601 33.8883 10.7833C35.7044 13.5137 36.6711 16.7208 36.6666 20C36.6666 29.205 29.2049 36.6666 19.9999 36.6666C10.7949 36.6666 3.33325 29.205 3.33325 20C3.33325 12.0667 8.87492 5.42998 16.2983 3.74665C16.7292 3.64909 17.1813 3.72666 17.5551 3.96231C17.9289 4.19796 18.1938 4.5724 18.2916 5.00332ZM21.6666 5.02332C21.6664 4.7733 21.7219 4.52638 21.829 4.30049C21.9362 4.0746 22.0923 3.87541 22.2861 3.71741C22.4798 3.5594 22.7064 3.44654 22.9492 3.38702C23.192 3.3275 23.4451 3.32282 23.6899 3.37332L23.8816 3.42498L28.8599 5.08498C29.2644 5.21864 29.6023 5.50208 29.8043 5.87709C30.0063 6.2521 30.057 6.69022 29.9461 7.10148C29.8352 7.51273 29.571 7.86592 29.2078 8.08849C28.8447 8.31107 28.4101 8.38615 27.9933 8.29832L27.8066 8.24832L24.9999 7.31165V20C24.9994 21.0471 24.6702 22.0676 24.0587 22.9176C23.4472 23.7676 22.5843 24.4041 21.5917 24.7375C20.5991 25.0708 19.5269 25.0841 18.5263 24.7755C17.5257 24.4669 16.6473 23.852 16.0149 23.0174C15.3825 22.1829 15.028 21.1709 15.0015 20.1241C14.975 19.0774 15.2778 18.0487 15.8672 17.1832C16.4566 16.3178 17.3028 15.6592 18.2865 15.3004C19.2702 14.9415 20.3417 14.9006 21.3499 15.1833L21.6666 15.2833V5.02498V5.02332Z'
              fill='white'
            />
          </svg>{' '}
          {song.title}
        </span>
      )
    if (col.key === 'release_date') return formatDate(song.release_date)
    if (col.key === 'actions')
      return (
        <div className='flex gap-2'>
          <button className='p-2 rounded hover:bg-gray-700' onClick={() => onEdit(song.id)}>
            <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none'>
              <path
                d='M16.475 5.40795L18.592 7.52495M17.836 3.54295L12.109 9.26995C11.8122 9.56479 11.6102 9.94156 11.529 10.3519L11 12.9999L13.648 12.4699C14.058 12.3879 14.434 12.1869 14.73 11.8909L20.457 6.16395C20.6291 5.99185 20.7656 5.78754 20.8588 5.56269C20.9519 5.33783 20.9998 5.09683 20.9998 4.85345C20.9998 4.61007 20.9519 4.36907 20.8588 4.14421C20.7656 3.91936 20.6291 3.71505 20.457 3.54295C20.2849 3.37085 20.0806 3.23434 19.8557 3.1412C19.6309 3.04806 19.3899 3.00012 19.1465 3.00012C18.9031 3.00012 18.6621 3.04806 18.4373 3.1412C18.2124 3.23434 18.0081 3.37085 17.836 3.54295Z'
                stroke='white'
                strokeOpacity='0.92'
                strokeWidth='2'
                strokeLinecap='round'
                strokeLinejoin='round'
              />
              <path
                d='M19 15V18C19 18.5304 18.7893 19.0391 18.4142 19.4142C18.0391 19.7893 17.5304 20 17 20H6C5.46957 20 4.96086 19.7893 4.58579 19.4142C4.21071 19.0391 4 18.5304 4 18V7C4 6.46957 4.21071 5.96086 4.58579 5.58579C4.96086 5.21071 5.46957 5 6 5H9'
                stroke='white'
                strokeOpacity='0.92'
                strokeWidth='2'
                strokeLinecap='round'
                strokeLinejoin='round'
              />
            </svg>
          </button>
          <button className='p-2 rounded hover:bg-gray-700' onClick={() => handleDelete(song.id)}>
            <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none'>
              <path
                d='M16.4141 12L17.8281 10.586C18.0103 10.3974 18.111 10.1448 18.1088 9.8826C18.1065 9.6204 18.0013 9.36959 17.8159 9.18418C17.6305 8.99877 17.3797 8.8936 17.1175 8.89133C16.8553 8.88905 16.6027 8.98984 16.4141 9.172L15.0001 10.586L13.5861 9.172C13.4938 9.07649 13.3835 9.00031 13.2615 8.9479C13.1395 8.89549 13.0083 8.8679 12.8755 8.86675C12.7427 8.8656 12.611 8.8909 12.4881 8.94118C12.3652 8.99146 12.2536 9.06571 12.1597 9.15961C12.0658 9.2535 11.9916 9.36515 11.9413 9.48805C11.891 9.61094 11.8657 9.74262 11.8668 9.8754C11.868 10.0082 11.8956 10.1394 11.948 10.2614C12.0004 10.3834 12.0766 10.4938 12.1721 10.586L13.5861 12L12.1721 13.414C12.0766 13.5062 12.0004 13.6166 11.948 13.7386C11.8956 13.8606 11.868 13.9918 11.8668 14.1246C11.8657 14.2574 11.891 14.3891 11.9413 14.512C11.9916 14.6349 12.0658 14.7465 12.1597 14.8404C12.2536 14.9343 12.3652 15.0085 12.4881 15.0588C12.611 15.1091 12.7427 15.1344 12.8755 15.1333C13.0083 15.1321 13.1395 15.1045 13.2615 15.0521C13.3835 14.9997 13.4938 14.9235 13.5861 14.828L15.0001 13.414L16.4141 14.828C16.5063 14.9235 16.6167 14.9997 16.7387 15.0521C16.8607 15.1045 16.9919 15.1321 17.1247 15.1333C17.2575 15.1344 17.3892 15.1091 17.512 15.0588C17.6349 15.0085 17.7466 14.9343 17.8405 14.8404C17.9344 14.7465 18.0086 14.6349 18.0589 14.512C18.1092 14.3891 18.1345 14.2574 18.1333 14.1246C18.1322 13.9918 18.1046 13.8606 18.0522 13.7386C17.9998 13.6166 17.9236 13.5062 17.8281 13.414L16.4141 12ZM9.82809 5H20.0001C20.5305 5 21.0392 5.21071 21.4143 5.58579C21.7894 5.96086 22.0001 6.46957 22.0001 7V17C22.0001 17.5304 21.7894 18.0391 21.4143 18.4142C21.0392 18.7893 20.5305 19 20.0001 19H9.82809C9.2977 18.9999 8.78908 18.7891 8.41409 18.414L2.70709 12.707C2.51962 12.5195 2.41431 12.2652 2.41431 12C2.41431 11.7348 2.51962 11.4805 2.70709 11.293L8.41409 5.586C8.78908 5.2109 9.2977 5.00011 9.82809 5Z'
                fill='#C02121'
              />
            </svg>
          </button>
        </div>
      )
    return song[col.key]
  }

  if (loading) {
    return <div className='text-center py-8'>Loading...</div>
  }

  return (
    <div>
      <div className='flex justify-between items-center mb-4'>
        <div className='font-bold text-xl'>List Library Songs</div>
        <div className='flex gap-2'>
          <input
            type='text'
            placeholder='Search Song'
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className='px-4 py-2 rounded bg-gray-800 text-white outline-none'
          />
          <button
            className='bg-[#EE10B0] text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2'
            onClick={onAdd}>
            <span>
              <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none'>
                <path
                  d='M7.00708 12C7.00708 11.801 7.0861 11.6103 7.22675 11.4696C7.3674 11.329 7.55817 11.25 7.75708 11.25H11.2501V7.75696C11.2501 7.55805 11.3291 7.36728 11.4698 7.22663C11.6104 7.08598 11.8012 7.00696 12.0001 7.00696C12.199 7.00696 12.3898 7.08598 12.5304 7.22663C12.6711 7.36728 12.7501 7.55805 12.7501 7.75696V11.25H16.2431C16.442 11.25 16.6328 11.329 16.7734 11.4696C16.9141 11.6103 16.9931 11.801 16.9931 12C16.9931 12.1989 16.9141 12.3896 16.7734 12.5303C16.6328 12.6709 16.442 12.75 16.2431 12.75H12.7501V16.243C12.7501 16.4419 12.6711 16.6326 12.5304 16.7733C12.3898 16.9139 12.199 16.993 12.0001 16.993C11.8012 16.993 11.6104 16.9139 11.4698 16.7733C11.3291 16.6326 11.2501 16.4419 11.2501 16.243V12.75H7.75708C7.55817 12.75 7.3674 12.6709 7.22675 12.5303C7.0861 12.3896 7.00708 12.1989 7.00708 12Z'
                  fill='white'
                />
                <path
                  fillRule='evenodd'
                  clipRule='evenodd'
                  d='M7.31692 3.76905C10.4294 3.42399 13.5704 3.42399 16.6829 3.76905C18.5099 3.97305 19.9849 5.41205 20.1989 7.24905C20.5689 10.406 20.5689 13.595 20.1989 16.752C19.9839 18.589 18.5089 20.027 16.6829 20.232C13.5704 20.5771 10.4294 20.5771 7.31692 20.232C5.48992 20.027 4.01492 18.589 3.80092 16.752C3.43257 13.5951 3.43257 10.406 3.80092 7.24905C4.01492 5.41205 5.49092 3.97305 7.31692 3.76905ZM16.5169 5.25905C13.5148 4.92627 10.4851 4.92627 7.48291 5.25905C6.92716 5.3207 6.40842 5.56792 6.01049 5.96076C5.61257 6.35361 5.35871 6.86913 5.28991 7.42405C4.93425 10.465 4.93425 13.5371 5.28991 16.578C5.35892 17.1328 5.61287 17.6481 6.01078 18.0407C6.40868 18.4334 6.92731 18.6804 7.48291 18.742C10.4599 19.074 13.5399 19.074 16.5169 18.742C17.0723 18.6802 17.5907 18.4331 17.9884 18.0404C18.3861 17.6478 18.64 17.1326 18.7089 16.578C19.0646 13.5371 19.0646 10.465 18.7089 7.42405C18.6397 6.86964 18.3858 6.35469 17.9882 5.96227C17.5905 5.56985 17.0722 5.32282 16.5169 5.26105'
                  fill='white'
                />
              </svg>
            </span>
            Add New Song
          </button>
        </div>
      </div>
      <CustomTable columns={columns} data={filteredSongs} rowsPerPage={10} renderCell={renderCell} />
    </div>
  )
}
